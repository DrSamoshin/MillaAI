# WebSocket Chat API для iOS

## Endpoint

```
ws://127.0.0.1:8000/v1/ws/chat
```


## Аутентификация

WebSocket требует Bearer токен в заголовке `Authorization` при подключении:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

Токен получается через REST API `/v1/auth/login` или `/v1/auth/apple-signin`.

## Протокол

### Подключение
1. Установить WebSocket соединение с заголовком Authorization
2. Сервер примет соединение если токен валидный
3. При ошибке аутентификации соединение закроется с кодом 1008

### Отправка сообщений
Отправляйте текстовые сообщения напрямую (не JSON):

```
"Привет, как дела?"
```

### Получение ответов
Сервер отправляет JSON ответы:

**Успешный ответ:**
```json
{
  "status": "success",
  "reply": "Привет! У меня все отлично, спасибо что спросил. Как у тебя дела?",
  "model": "gpt-4"
}
```

**Ошибка:**
```json
{
  "status": "error",
  "error": {
    "code": "chat.ws_internal_error",
    "message": "Failed to process message.",
    "details": {"reason": "..."}
  }
}
```

## Обработка ошибок

1. **1008 Policy Violation** - проблема с токеном (отсутствует, невалидный, истек)
2. **1001 Going Away** - сервер завершает соединение
3. **Network errors** - проблемы с сетью

## Особенности

- Каждое сообщение сохраняется в кеш (до 30 сообщений)
- Сессия завершается по TTL (600 секунд неактивности)
- История диалога передается LLM для контекста
- Поддержка только текстовых сообщений
